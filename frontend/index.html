<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI for IA - Secure Video Conference</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"/>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. Root Variables & Reset --- */
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --secondary: #34a853;
            --danger: #ea4335;
            --warning: #f9ab00;
            --dark: #202124;
            --dark-light: #3c4043;
            --dark-lighter: #2a2b2e;
            --gray: #5f6368;
            --light: #e8f0fe;
            --white: #ffffff;
            --text-primary: #e8eaed;
            --text-secondary: #bdc1c6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark);
            color: var(--text-primary);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .hidden { 
            display: none !important; 
        }

        /* --- 2. Setup Screen --- */
        #setup {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--dark-light) 0%, var(--dark) 100%);
        }

        .setup-container {
            background-color: var(--dark-lighter);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 24px;
            text-align: center;
            max-width: 450px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setup-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 0;
        }

        .setup-header i {
            font-size: 28px;
            color: var(--primary);
        }

        .setup-header h2 {
            font-size: 26px;
            font-weight: 600;
            color: var(--white);
        }

        .security-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            color: var(--secondary);
            background: rgba(52, 168, 83, 0.1);
            padding: 8px 12px;
            border-radius: var(--border-radius-sm);
            border: 1px solid rgba(52, 168, 83, 0.3);
        }

        .security-badge i {
            font-size: 16px;
        }

        #setup input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--gray);
            background-color: var(--dark-light);
            color: var(--text-primary);
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            transition: var(--transition);
        }

        #setup input:focus {
            outline: none;
            border-color: var(--primary);
            background-color: var(--dark-light);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.3);
        }

        #setup input::placeholder {
            color: var(--text-secondary);
        }

        #joinBtn {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 14px 24px;
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        #joinBtn:hover {
            transform: translateY(-2px);
            background: var(--primary-dark);
            box-shadow: 0 6px 15px rgba(26, 115, 232, 0.2);
        }
        
        /* --- 3. Main Room Screen --- */
        #room {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: var(--dark);
            overflow: hidden;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            background-color: var(--dark-lighter);
            border-bottom: 1px solid var(--dark-light);
            flex-shrink: 0;
        }

        .room-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .room-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 18px;
            color: var(--white);
        }

        .room-name i {
            color: var(--primary);
        }

        .participant-count {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .security-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--secondary);
        }
        
        /* --- 4. Videos Container --- */
        #main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            padding: 16px;
            gap: 16px;
        }

        /* Default Grid View */
        #videos {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            grid-auto-rows: min-content;
            gap: 16px;
            overflow-y: auto;
            align-items: start;
            justify-items: center;
        }
        
        /* Pinned View */
        #pinned-column {
            display: none;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--gray) var(--dark-light);
        }

        /* Main videos grid shrinks when pin is active */
        #main-content.pin-active #videos {
            flex: 3;
            grid-template-columns: 1fr;
        }
        
        /* Side column becomes visible */
        #main-content.pin-active #pinned-column {
            display: flex;
            flex: 1;
            min-width: 280px;
            max-width: 320px;
        }
        
        /* Tiles in the side column are smaller */
        #main-content.pin-active #pinned-column .video-player-container {
            max-height: 200px;
        }
        
        /* --- 5. Screen Sharing Layout --- */
        #participants-strip {
            display: none;
            width: 100%;
            background-color: var(--dark-lighter);
            padding: 12px;
            flex-shrink: 0;
            overflow-x: auto;
            gap: 12px;
            scrollbar-width: thin;
            scrollbar-color: var(--gray) var(--dark);
        }
        
        /* When local user shares screen... */
        #room.local-screen-sharing {
            flex-direction: column;
        }

        #room.local-screen-sharing #main-content {
            flex: 1;
        }
        
        #room.local-screen-sharing #videos {
            grid-template-columns: 1fr;
            overflow: hidden;
        }
        
        #room.local-screen-sharing #participants-strip {
            display: flex;
        }
        
        /* The video tile containing the screen */
        .video-player-container.screen-sharing-source {
            width: 100%;
            height: 100%;
            max-height: none;
            border: none;
            background-color: var(--dark);
        }
        
        /* Other participants in the bottom strip */
        #room.local-screen-sharing #participants-strip .video-player-container {
            width: 220px;
            height: 140px;
            flex-shrink: 0;
        }
        
        /* Hide controls on minimized videos */
        #room.local-screen-sharing #participants-strip .pin-btn,
        #room.local-screen-sharing #participants-strip .video-status-overlay {
            display: none !important;
        }

        /* --- 6. Video Player Tile --- */
        .video-player-container {
            position: relative;
            background-color: var(--dark-light);
            border-radius: var(--border-radius-md);
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
            width: 100%;
            aspect-ratio: 16 / 9;
            max-height: 450px;
            border: 2px solid transparent;
        }

        .video-player-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Highlight for local user */
        #localVideoContainer {
            border: 2px solid var(--primary);
        }
        
        /* Speaking highlight */
        .video-player-container.speaking {
            border-color: var(--secondary);
            box-shadow: 0 0 15px rgba(52, 168, 83, 0.5);
        }

        /* --- Status Overlays --- */
        .video-status-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: var(--white);
            backdrop-filter: blur(4px);
            z-index: 5;
        }

        /* Show overlay when class is added */
        .video-player-container.audio-muted .mic-off-overlay {
            display: flex;
        }
        .video-player-container.video-off .cam-off-overlay {
            display: flex;
        }
        /* When both are off, stack them */
        .video-player-container.audio-muted.video-off .video-status-overlay {
            font-size: 28px;
        }
        .video-player-container.audio-muted.video-off .mic-off-overlay {
            top: -30px;
        }
        .video-player-container.audio-muted.video-off .cam-off-overlay {
            bottom: -30px;
        }

        /* --- Captions Display --- */
        .captions-display {
            position: absolute;
            bottom: 60px;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            font-size: 14px;
            text-align: center;
            z-index: 10;
            border-radius: 0 0 var(--border-radius-md) var(--border-radius-md);
            display: none;
        }

        /* Show captions when speaking AND captions are enabled */
        .video-player-container.speaking .captions-display:not(:empty) {
            display: block;
        }

        /* --- Pin Button --- */
        .pin-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.4);
            color: var(--white);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            opacity: 0;
            transform: scale(0.8);
        }
        
        .video-player-container:hover .pin-btn {
            opacity: 1;
            transform: scale(1);
        }
        
        .pin-btn:hover {
            background: var(--primary);
        }
        
        /* Pinned state */
        .video-player-container.pinned .pin-btn {
            background: var(--primary);
            color: var(--white);
            opacity: 1;
            transform: scale(1);
        }
        
        /* Hide pin button when screen sharing */
        .video-player-container.screen-sharing-source .pin-btn {
            display: none;
        }

        /* --- Video Overlay (Bottom bar) --- */
        .video-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            z-index: 2;
        }

        .participant-name {
            color: white;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .participant-name.you::after {
            content: "(You)";
            font-size: 12px;
            opacity: 0.8;
        }

        .status-indicators {
            display: flex;
            gap: 8px;
        }

        .status-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .status-icon.muted { background-color: var(--danger); }
        .status-icon.camera-off { background-color: var(--gray); }
        /* Hide old camera icon, we use overlay now */
        .status-icon.camera-off { display: none; }

        /* --- 7. Controls Bar --- */
        #controls {
            background-color: var(--dark-lighter);
            padding: 16px 24px;
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-shrink: 0;
            z-index: 20;
            border-top: 1px solid var(--dark-light);
        }

        .control-btn {
            background-color: var(--dark-light);
            border: none;
            color: var(--text-primary);
            width: 64px;
            height: 56px;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 500;
            transition: var(--transition);
        }

        .control-btn i {
            font-size: 20px;
        }

        .control-btn:hover {
            background-color: var(--gray);
            transform: translateY(-2px);
        }

        .control-btn.toggled {
            background-color: var(--primary);
            color: var(--white);
        }
        
        .control-btn.toggled:hover {
             background-color: var(--primary-dark);
        }

        .control-btn.end-call {
            background-color: var(--danger);
            color: var(--white);
        }

        .control-btn.end-call:hover {
            background-color: #c5221f;
        }

        /* --- 8. Chat Sidebar --- */
        #chat-sidebar {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100%;
            background-color: var(--dark-lighter);
            border-left: 1px solid var(--dark-light);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            z-index: 100;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
        }

        #chat-sidebar.open {
            right: 0;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--dark-light);
            background-color: var(--dark-lighter);
        }

        .chat-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--white);
        }

        .close-chat {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-chat:hover {
            color: var(--white);
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            padding: 12px;
            background-color: var(--dark-light);
            border-radius: var(--border-radius-md);
            max-width: 85%;
        }

        .chat-message.own {
            align-self: flex-end;
            background-color: var(--primary);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 14px;
        }

        .message-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chat-message.own .message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .message-text {
            font-size: 14px;
            line-height: 1.4;
        }

        #chat-input-container {
            padding: 16px;
            border-top: 1px solid var(--dark-light);
            background-color: var(--dark-lighter);
        }

        #chat-input-form {
            display: flex;
            gap: 8px;
        }

        #chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--gray);
            background-color: var(--dark-light);
            color: var(--text-primary);
            border-radius: var(--border-radius-sm);
            font-size: 14px;
        }

        #chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        #chat-send {
            background-color: var(--primary);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius-sm);
            padding: 0 16px;
            cursor: pointer;
            transition: var(--transition);
        }

        #chat-send:hover {
            background-color: var(--primary-dark);
        }

        /* --- 9. Responsive Design --- */
        
        /* Scrollbar styling */
        #videos::-webkit-scrollbar,
        #pinned-column::-webkit-scrollbar,
        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        #videos::-webkit-scrollbar-track,
        #pinned-column::-webkit-scrollbar-track,
        #chat-messages::-webkit-scrollbar-track {
            background: var(--dark-light);
            border-radius: 4px;
        }
        #videos::-webkit-scrollbar-thumb,
        #pinned-column::-webkit-scrollbar-thumb,
        #chat-messages::-webkit-scrollbar-thumb {
            background: var(--gray);
            border-radius: 4px;
        }
        #videos::-webkit-scrollbar-thumb:hover,
        #pinned-column::-webkit-scrollbar-thumb:hover,
        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
        
        #participants-strip::-webkit-scrollbar {
            height: 8px;
        }
        #participants-strip::-webkit-scrollbar-track {
            background: var(--dark);
        }
        #participants-strip::-webkit-scrollbar-thumb {
            background: var(--gray);
            border-radius: 4px;
        }

        @media (max-width: 900px) {
            /* On medium screens, pin column is on top/bottom */
            #main-content.pin-active {
                flex-direction: column;
            }
            #main-content.pin-active #videos {
                flex: 3;
            }
            #main-content.pin-active #pinned-column {
                flex: 1;
                flex-direction: row;
                overflow-x: auto;
                overflow-y: hidden;
                min-width: 100%;
                max-width: 100%;
                max-height: 150px;
            }
            #main-content.pin-active #pinned-column .video-player-container {
                width: 200px;
                height: 120px;
                flex-shrink: 0;
            }
            
            /* Chat sidebar on mobile */
            #chat-sidebar {
                width: 100%;
                right: -100%;
            }
        }
        
        @media (max-width: 768px) {
            .setup-container {
                padding: 30px 20px;
            }
            
            #main-content {
                padding: 10px;
                gap: 10px;
            }
            
            #videos {
                grid-template-columns: 1fr;
                padding: 0;
                gap: 10px;
            }
            
            .control-btn {
                width: 60px;
                height: 54px;
            }
            
            .room-header {
                padding: 10px 15px;
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .room-info {
                width: 100%;
                justify-content: space-between;
            }
        }

        @media (max-width: 480px) {
            #controls {
                gap: 10px;
                padding: 12px;
                justify-content: flex-start;
                overflow-x: auto;
            }
            
            .control-btn {
                width: 55px;
                height: 55px;
                font-size: 11px;
                flex-shrink: 0;
            }
        }

        /* --- 10. Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .video-player-container {
            animation: fadeIn 0.4s ease;
        }
    </style>
</head>

<body>
    <div id="setup">
        <div class="setup-container">
            <div class="setup-header">
                <i class="fas fa-video"></i>
                <h2>AI for IA Meeting</h2>
            </div>
            <div class="security-badge">
                <i class="fas fa-shield-alt"></i>
                <span>End-to-End Encrypted</span>
            </div>
            <input type="text" id="roomInput" placeholder="Enter Room Name" />
            <input type="text" id="nameInput" placeholder="Enter Your Name" value="Guest" />
            <button id="joinBtn">
                <i class="fas fa-sign-in-alt"></i>
                <span>Join Secure Meeting</span>
            </button>
        </div>
    </div>

    <div id="room" class="hidden">
        <div class="room-header">
            <div class="room-info">
                <div class="room-name">
                    <i class="fas fa-door-open"></i>
                    <span id="currentRoomName">Room Name</span>
                </div>
                <div class="participant-count">
                    <i class="fas fa-users"></i>
                    <span id="participantCount">1 participant</span>
                </div>
            </div>
            <div class="security-indicator">
                <i class="fas fa-lock"></i>
                <span>Secured Connection</span>
            </div>
        </div>
        
        <div id="main-content">
            <div id="videos"></div>
            <div id="pinned-column"></div>
        </div>
        
        <div id="participants-strip"></div>
        
        <div id="controls">
            <button id="muteBtn" class="control-btn">
                <i class="fas fa-microphone"></i>
                <span>Mute</span>
            </button>
            <button id="cameraBtn" class="control-btn">
                <i class="fas fa-video"></i>
                <span>Video</span>
            </button>
            <button id="shareScreenBtn" class="control-btn">
                <i class="fas fa-desktop"></i>
                <span>Share</span>
            </button>
            <button id="captionsBtn" class="control-btn">
                <i class="fas fa-closed-captioning"></i>
                <span>Captions</span>
            </button>
            <button id="chatBtn" class="control-btn">
                <i class="fas fa-comments"></i>
                <span>Chat</span>
            </button>
            <button id="endBtn" class="control-btn end-call">
                <i class="fas fa-phone-slash"></i>
                <span>Leave</span>
            </button>
        </div>
    </div>

    <!-- Chat Sidebar -->
    <div id="chat-sidebar">
        <div class="chat-header">
            <h3>Meeting Chat</h3>
            <button class="close-chat" id="closeChatBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input-container">
            <form id="chat-input-form">
                <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off" />
                <button type="submit" id="chat-send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

<script>
    // --- DOM Elements ---
    const setupDiv = document.getElementById("setup");
    const roomDiv = document.getElementById("room");
    const roomInput = document.getElementById("roomInput");
    const nameInput = document.getElementById("nameInput");
    const joinBtn = document.getElementById("joinBtn");
    
    // Main content containers
    const mainContentDiv = document.getElementById("main-content");
    const videosDiv = document.getElementById("videos");
    const pinnedColumnDiv = document.getElementById("pinned-column");
    const participantsStripDiv = document.getElementById("participants-strip");
    
    // Control buttons
    const muteBtn = document.getElementById("muteBtn");
    const cameraBtn = document.getElementById("cameraBtn");
    const shareScreenBtn = document.getElementById("shareScreenBtn");
    const captionsBtn = document.getElementById("captionsBtn");
    const chatBtn = document.getElementById("chatBtn");
    const endBtn = document.getElementById("endBtn");
    const currentRoomName = document.getElementById("currentRoomName");
    const participantCount = document.getElementById("participantCount");
    
    // Chat elements
    const chatSidebar = document.getElementById("chat-sidebar");
    const closeChatBtn = document.getElementById("closeChatBtn");
    const chatMessages = document.getElementById("chat-messages");
    const chatInputForm = document.getElementById("chat-input-form");
    const chatInput = document.getElementById("chat-input");

    // --- WebRTC ---
    let ws, localStream, cameraStream, pcs = {};
    let myId = Math.random().toString(36).substring(2, 9);
    let myName = "";
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const SPEAKING_THRESHOLD = 5;
    let isScreenSharing = false;
    
    // Pinning state
    let pinnedParticipantId = null;
    
    // Captions state
    let captionsEnabled = false;
    let sttWebSocket = null;
    let activeSpeakerId = null;
    let captionInterval = null;

    // --- Helper: Get room ID from URL ---
    function getRoomIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('room_id') || urlParams.get('room') || '';
    }

    // --- Helper: Monitor audio level for speaking highlight ---
    function monitorAudioLevel(stream, videoContainerId) {
        if (!audioContext || !stream.getAudioTracks().length) return;
        const analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);
        analyser.fftSize = 512;
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        const container = document.getElementById(videoContainerId);
        
        function checkVolume() {
            if (!container) return;
            analyser.getByteFrequencyData(dataArray);
            let sum = dataArray.reduce((a, b) => a + b, 0);
            const average = sum / dataArray.length;
            
            if (stream.getAudioTracks()[0]?.enabled && average > SPEAKING_THRESHOLD) {
                container.classList.add('speaking');
                if (captionsEnabled && videoContainerId !== 'localVideoContainer') {
                    activeSpeakerId = videoContainerId;
                }
            } else {
                container.classList.remove('speaking');
                if (activeSpeakerId === videoContainerId) {
                    activeSpeakerId = null;
                }
            }
            requestAnimationFrame(checkVolume);
        }
        requestAnimationFrame(checkVolume);
    }

    // --- Video Element Builder (MODIFIED) ---
    function createVideoPlayer(id, name, stream, isMuted = false, audioEnabled = true, videoEnabled = true, isLocal = false) {
        const container = document.createElement("div");
        container.id = id;
        container.className = "video-player-container";
        
        // Add status classes
        if (!audioEnabled) container.classList.add('audio-muted');
        if (!videoEnabled) container.classList.add('video-off');

        const video = document.createElement("video");
        video.autoplay = true;
        video.playsInline = true;
        video.muted = isMuted;
        video.srcObject = stream;
        
        const overlay = document.createElement("div");
        overlay.className = "video-overlay";
        
        const nameTag = document.createElement("div");
        nameTag.className = `participant-name ${isLocal ? 'you' : ''}`;
        nameTag.textContent = name;
        if (isLocal) {
            nameTag.textContent = `${name} `;
        }
        
        // Bottom-right status icons
        const statusIndicators = document.createElement("div");
        statusIndicators.className = "status-indicators";
        const micIcon = document.createElement("div");
        micIcon.className = `status-icon ${!audioEnabled ? 'muted' : ''}`;
        micIcon.innerHTML = `<i class="fas ${audioEnabled ? 'fa-microphone' : 'fa-microphone-slash'}"></i>`;
        
        // Center overlays
        const micOffOverlay = document.createElement("div");
        micOffOverlay.className = "video-status-overlay mic-off-overlay";
        micOffOverlay.innerHTML = `<i class="fas fa-microphone-slash"></i>`;
        
        const camOffOverlay = document.createElement("div");
        camOffOverlay.className = "video-status-overlay cam-off-overlay";
        camOffOverlay.innerHTML = `<i class="fas fa-video-slash"></i>`;
        
        // Captions display
        const captionsDisplay = document.createElement("div");
        captionsDisplay.className = "captions-display";
        captionsDisplay.id = `${id}-captions`;
        
        // Pin button
        const pinBtn = document.createElement("button");
        pinBtn.className = "pin-btn";
        pinBtn.innerHTML = `<i class="fas fa-thumbtack"></i>`;
        pinBtn.onclick = () => togglePin(id);

        statusIndicators.appendChild(micIcon);
        overlay.appendChild(nameTag);
        overlay.appendChild(statusIndicators);
        
        container.appendChild(video);
        container.appendChild(overlay);
        container.appendChild(micOffOverlay);
        container.appendChild(camOffOverlay);
        container.appendChild(captionsDisplay);
        container.appendChild(pinBtn);
        
        // Add to the main grid by default
        videosDiv.appendChild(container);
        
        updateParticipantCount();
        return container;
    }

    // --- Helper: Update participant count ---
    function updateParticipantCount() {
        const count = document.querySelectorAll('.video-player-container').length;
        participantCount.textContent = `${count} participant${count !== 1 ? 's' : ''}`;
    }
    
    // --- Pin/Unpin Logic ---
    function togglePin(id) {
        const container = document.getElementById(id);
        if (!container) return;

        if (pinnedParticipantId === id) {
            // Unpin
            pinnedParticipantId = null;
            container.classList.remove('pinned');
            mainContentDiv.classList.remove('pin-active');
            
            // Move everyone from pinned-column back to videosDiv
            Array.from(pinnedColumnDiv.children).forEach(child => videosDiv.appendChild(child));
            
        } else {
            // Pin
            const oldPinnedId = pinnedParticipantId;
            pinnedParticipantId = id;

            // Remove old pin class
            if (oldPinnedId) {
                document.getElementById(oldPinnedId)?.classList.remove('pinned');
            }
            
            // Add new pin class
            container.classList.add('pinned');
            mainContentDiv.classList.add('pin-active');
            
            // Move the pinned video to the main #videos grid
            videosDiv.appendChild(container);

            // Move all *other* videos to the pinned column
            Array.from(videosDiv.children).forEach(child => {
                if (child.id !== id) {
                    pinnedColumnDiv.appendChild(child);
                }
            });
            
            // Move local video to pinned column if it's not the one being pinned
            const localContainer = document.getElementById('localVideoContainer');
            if (localContainer && localContainer.id !== id) {
                pinnedColumnDiv.appendChild(localContainer);
            }
        }
        updateParticipantCount();
    }
    
    // --- Screen Share Layout Manager ---
    function manageScreenShareLayout(isSharing) {
        if (isSharing) {
            isScreenSharing = true;
            roomDiv.classList.add('local-screen-sharing');
            const localContainer = document.getElementById('localVideoContainer');
            localContainer.classList.add('screen-sharing-source');
            
            // Move local container (screen) to main grid
            videosDiv.appendChild(localContainer);
            
            // Move all *other* videos to the participants strip
            Array.from(videosDiv.children).forEach(child => {
                if (child.id !== 'localVideoContainer') {
                    participantsStripDiv.appendChild(child);
                }
            });
            // Also move from pinned column
            Array.from(pinnedColumnDiv.children).forEach(child => {
                if (child.id !== 'localVideoContainer') {
                    participantsStripDiv.appendChild(child);
                }
            });
            
        } else {
            isScreenSharing = false;
            roomDiv.classList.remove('local-screen-sharing');
            const localContainer = document.getElementById('localVideoContainer');
            localContainer.classList.remove('screen-sharing-source');
            
            // Move all participants from strip back to main grid
            Array.from(participantsStripDiv.children).forEach(child => videosDiv.appendChild(child));
            
            // Re-apply pin if it was active
            if (pinnedParticipantId) {
                togglePin(pinnedParticipantId);
            }
        }
    }

    // --- Captions System ---
    function toggleCaptions() {
        captionsEnabled = !captionsEnabled;
        
        if (captionsEnabled) {
            // Start captions
            connectSTTWebSocket();
            captionsBtn.classList.add('toggled');
            captionsBtn.querySelector("span").textContent = 'Stop Captions';
            captionsBtn.querySelector("i").className = 'fas fa-closed-captioning';
            console.log("ðŸ”¤ Captions enabled");
        } else {
            // Stop captions
            stopCaptions();
            captionsBtn.classList.remove('toggled');
            captionsBtn.querySelector("span").textContent = 'Captions';
            captionsBtn.querySelector("i").className = 'fas fa-closed-captioning';
            console.log("ðŸ”¤ Captions disabled");
        }
    }

    function connectSTTWebSocket() {
        // In a real implementation, connect to your STT service
        // For demo purposes, we'll simulate captions
        
        console.log("ðŸ”¤ Starting captions service...");
        
        // Clear any existing interval first
        if (captionInterval) {
            clearInterval(captionInterval);
        }
        
        // Start simulating captions
        captionInterval = setInterval(() => {
            updateCaptionsForActiveSpeaker();
        }, 3000);
        
        // For a real STT service, you would do something like:
        /*
        const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const sttUrl = `${wsProtocol}//${location.host}/stt/${sessionStorage.getItem('room')}`;
        
        sttWebSocket = new WebSocket(sttUrl);
        
        sttWebSocket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'transcription' && data.userId) {
                const containerId = `remoteContainer-${data.userId}`;
                const captionsDisplay = document.querySelector(`#${containerId} .captions-display`);
                if (captionsDisplay) {
                    captionsDisplay.textContent = data.text;
                    // Auto-hide after 5 seconds if no new text
                    setTimeout(() => {
                        if (captionsDisplay.textContent === data.text) {
                            captionsDisplay.textContent = '';
                        }
                    }, 5000);
                }
            }
        };
        
        sttWebSocket.onerror = (error) => {
            console.error('STT WebSocket error:', error);
        };
        */
    }

    function stopCaptions() {
        console.log("ðŸ”¤ Stopping captions service...");
        
        // Clear the simulation interval
        if (captionInterval) {
            clearInterval(captionInterval);
            captionInterval = null;
        }
        
        // Close STT WebSocket if connected
        if (sttWebSocket && sttWebSocket.readyState === WebSocket.OPEN) {
            sttWebSocket.close();
            sttWebSocket = null;
        }
        
        // Clear all captions displays
        document.querySelectorAll('.captions-display').forEach(display => {
            display.textContent = '';
        });
        
        activeSpeakerId = null;
    }

    function updateCaptionsForActiveSpeaker() {
        if (!captionsEnabled) return;
        
        // Sample captions for demonstration
        const sampleCaptions = [
            "Hello everyone, how are you doing today?",
            "I think we should discuss the quarterly results.",
            "The numbers look promising compared to last quarter.",
            "We need to focus on our marketing strategy.",
            "Let's schedule a follow-up meeting for next week.",
            "Does anyone have questions about the presentation?",
            "I agree with that approach completely.",
            "We should consider the budget implications.",
            "The timeline seems reasonable to me.",
            "Thank you all for your contributions today."
        ];
        
        // If we have an active speaker, show captions for them
        if (activeSpeakerId) {
            const randomCaption = sampleCaptions[Math.floor(Math.random() * sampleCaptions.length)];
            const captionsDisplay = document.querySelector(`#${activeSpeakerId} .captions-display`);
            if (captionsDisplay) {
                captionsDisplay.textContent = randomCaption;
                console.log(`ðŸ”¤ Showing caption for ${activeSpeakerId}: "${randomCaption}"`);
                
                // Auto-clear after 5 seconds
                setTimeout(() => {
                    if (captionsDisplay.textContent === randomCaption) {
                        captionsDisplay.textContent = '';
                    }
                }, 5000);
            }
        } else {
            // If no active speaker, clear all captions after a delay
            setTimeout(() => {
                document.querySelectorAll('.captions-display').forEach(display => {
                    if (display.textContent) {
                        display.textContent = '';
                    }
                });
            }, 2000);
        }
    }

    // --- Chat System ---
    function toggleChat() {
        chatSidebar.classList.toggle('open');
        chatBtn.classList.toggle('toggled');
    }

    function sendChatMessage(message) {
        if (!message.trim()) return;
        
        // Add message to UI
        addMessageToChat(myName, message, true);
        
        // Send message to other participants
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: "chat-message",
                from: myId,
                name: myName,
                message: message,
                timestamp: new Date().toISOString()
            }));
        }
        
        // Clear input
        chatInput.value = '';
    }

    function addMessageToChat(sender, message, isOwn = false) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `chat-message ${isOwn ? 'own' : ''}`;
        
        const messageHeader = document.createElement("div");
        messageHeader.className = "message-header";
        
        const senderSpan = document.createElement("span");
        senderSpan.className = "message-sender";
        senderSpan.textContent = sender;
        
        const timeSpan = document.createElement("span");
        timeSpan.className = "message-time";
        timeSpan.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        const messageText = document.createElement("div");
        messageText.className = "message-text";
        messageText.textContent = message;
        
        messageHeader.appendChild(senderSpan);
        messageHeader.appendChild(timeSpan);
        messageDiv.appendChild(messageHeader);
        messageDiv.appendChild(messageText);
        
        chatMessages.appendChild(messageDiv);
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // --- Helper: Set Local Stream ---
    function setLocalStream(stream) {
        localStream = stream;
        let localVideo = document.getElementById("localVideoContainer");
        
        const audioEnabled = stream.getAudioTracks()[0]?.enabled ?? true;
        const videoEnabled = stream.getVideoTracks()[0]?.enabled ?? true;

        if (!localVideo) {
            localVideo = createVideoPlayer("localVideoContainer", myName, stream, true, audioEnabled, videoEnabled, true);
        } else {
            localVideo.querySelector("video").srcObject = stream;
        }
        
        // Update local UI
        localVideo.classList.toggle('audio-muted', !audioEnabled);
        localVideo.classList.toggle('video-off', !videoEnabled);

        // Update all peer connections
        for (const id in pcs) {
            const pc = pcs[id];
            stream.getTracks().forEach(track => {
                const sender = pc.getSenders().find(s => s.track && s.track.kind === track.kind);
                if (sender) sender.replaceTrack(track).catch(console.error);
            });
        }
    }

    // --- Helper: Create Peer Connection ---
    function createPeerConnection(remoteId, remoteName, initialAudioState, initialVideoState) {
        const pc = new RTCPeerConnection({ 
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ] 
        });
        pcs[remoteId] = pc;
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        pc.ontrack = (e) => {
            const stream = e.streams[0]; 
            const containerId = `remoteContainer-${remoteId}`;
            let remoteContainer = document.getElementById(containerId);
            if (!remoteContainer) {
                createVideoPlayer(containerId, remoteName, stream, false, initialAudioState, initialVideoState, false);
            } else {
                remoteContainer.querySelector("video").srcObject = stream;
            }
            monitorAudioLevel(stream, containerId);
        };

        pc.onicecandidate = (e) => {
            if (e.candidate && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ 
                    type: "candidate", 
                    candidate: e.candidate, 
                    from: myId, 
                    to: remoteId 
                }));
            }
        };

        return pc;
    }

    // --- WebSocket (MODIFIED) ---
    function connectWebSocket(room) {
        const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${location.host}/ws/${room}`;
        
        console.log(`ðŸŒ Connecting to WebSocket: ${wsUrl}`);
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            console.log("âœ… WebSocket connected successfully");
            // Send both audio and video state on join
            ws.send(JSON.stringify({
                type: "join",
                from: myId,
                name: myName,
                audioEnabled: localStream.getAudioTracks()[0]?.enabled ?? true,
                videoEnabled: localStream.getVideoTracks()[0]?.enabled ?? true
            }));
        };

        ws.onmessage = async (e) => {
            if (e.data === '{"type": "ping"}' || e.data.includes('"type":"ping"')) return;
            const msg = JSON.parse(e.data);
            console.log("ðŸ“© Message received:", msg);

            if (msg.from === myId) return;

            let pc = pcs[msg.from];
            if (!pc && (msg.type === "offer" || msg.type === "join")) {
                // Create PC with initial audio/video state
                pc = createPeerConnection(msg.from, msg.name, msg.audioEnabled, msg.videoEnabled);
            }

            switch (msg.type) {
                case "join":
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    // Send our state
                    ws.send(JSON.stringify({
                        ...pc.localDescription.toJSON(),
                        from: myId,
                        to: msg.from,
                        name: myName,
                        audioEnabled: localStream.getAudioTracks()[0]?.enabled ?? true,
                        videoEnabled: localStream.getVideoTracks()[0]?.enabled ?? true
                    }));
                    break;
                case "offer":
                    await pc.setRemoteDescription(new RTCSessionDescription(msg));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    // Send our state
                    ws.send(JSON.stringify({
                        ...pc.localDescription.toJSON(),
                        from: myId,
                        to: msg.from,
                        name: myName,
                        audioEnabled: localStream.getAudioTracks()[0]?.enabled ?? true,
                        videoEnabled: localStream.getVideoTracks()[0]?.enabled ?? true
                    }));
                    break;
                case "answer":
                    await pc.setRemoteDescription(new RTCSessionDescription(msg));
                    break;
                case "candidate":
                    if (pc) await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
                    break;
                case "audio-toggle":
                    const aContainer = document.getElementById(`remoteContainer-${msg.from}`);
                    if (aContainer) {
                        // Update overlay
                        aContainer.classList.toggle("audio-muted", !msg.enabled);
                        // Update bottom-right icon
                        const micIcon = aContainer.querySelector(".status-icon");
                        micIcon.classList.toggle("muted", !msg.enabled);
                        micIcon.querySelector("i").className = `fas ${msg.enabled ? 'fa-microphone' : 'fa-microphone-slash'}`;
                    }
                    break;
                case "video-toggle":
                    const vContainer = document.getElementById(`remoteContainer-${msg.from}`);
                    if (vContainer) {
                        vContainer.classList.toggle("video-off", !msg.enabled);
                    }
                    break;
                case "chat-message":
                    addMessageToChat(msg.name, msg.message, false);
                    break;
                case "user-left":
                    if (pcs[msg.id]) {
                        pcs[msg.id].close();
                        delete pcs[msg.id];
                        // If pinned user leaves, unpin
                        if(pinnedParticipantId === `remoteContainer-${msg.id}`) {
                            togglePin(pinnedParticipantId);
                        }
                        document.getElementById(`remoteContainer-${msg.id}`)?.remove();
                        updateParticipantCount();
                    }
                    break;
            }
        };

        ws.onerror = (err) => { console.error("âŒ WebSocket error:", err); };
        ws.onclose = (e) => {
            console.warn("âš ï¸ WebSocket closed:", e.reason || "no reason");
            // Also stop captions when WebSocket closes
            if (captionsEnabled) {
                stopCaptions();
                captionsEnabled = false;
                captionsBtn.classList.remove('toggled');
                captionsBtn.querySelector("span").textContent = 'Captions';
            }
            
            setTimeout(() => {
                console.log("ðŸ”„ Attempting WebSocket reconnect...");
                connectWebSocket(room);
            }, 5000);
        };
    }

    // --- Join Call ---
    async function joinCall(room, name) {
        myName = name;
        setupDiv.classList.add("hidden");
        roomDiv.classList.remove("hidden");
        currentRoomName.textContent = room;

        sessionStorage.setItem('room', room);
        sessionStorage.setItem('name', name);

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            cameraStream = stream;
            const savedMic = sessionStorage.getItem('micMuted') === 'true';
            const savedCam = sessionStorage.getItem('cameraOff') === 'true';
            
            if (stream.getAudioTracks()[0] && savedMic) stream.getAudioTracks()[0].enabled = false;
            if (stream.getVideoTracks()[0] && savedCam) stream.getVideoTracks()[0].enabled = false;
            
            setLocalStream(cameraStream);
            monitorAudioLevel(cameraStream, "localVideoContainer");
            updateControlButtons();
        } catch (e) {
            console.error("Media error", e);
            alert("Could not access camera and microphone. Please check permissions.");
            return;
        }

        connectWebSocket(room);
    }

    // --- Control Buttons Logic ---
    function updateControlButtons() {
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
            const isMuted = !audioTrack.enabled;
            muteBtn.classList.toggle("toggled", isMuted);
            muteBtn.querySelector("i").className = `fas ${isMuted ? 'fa-microphone-slash' : 'fa-microphone'}`;
            muteBtn.querySelector("span").textContent = isMuted ? 'Unmute' : 'Mute';
        }
        const videoTrack = localStream.getVideoTracks()[0];
        if (videoTrack) {
            const isCameraOff = !videoTrack.enabled;
            cameraBtn.classList.toggle("toggled", isCameraOff);
            cameraBtn.querySelector("i").className = isCameraOff ? 'fas fa-video-slash' : 'fas fa-video';
            cameraBtn.querySelector("span").textContent = isCameraOff ? 'Camera On' : 'Camera Off';
        }
    }

    // --- UI Button Handlers ---
    const roomFromUrl = getRoomIdFromURL();
    roomInput.value = roomFromUrl;
    joinBtn.onclick = () => joinCall(roomInput.value.trim() || "default-room", nameInput.value.trim() || "Guest");

    muteBtn.onclick = () => {
        const track = localStream.getAudioTracks()[0];
        if (track) {
            track.enabled = !track.enabled;
            sessionStorage.setItem('micMuted', !track.enabled);
            updateControlButtons();
            
            // Update local UI overlay
            document.getElementById('localVideoContainer').classList.toggle('audio-muted', !track.enabled);
            
            // Send to others
            if(ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "audio-toggle", enabled: track.enabled, from: myId }));
            }
        }
    };

    cameraBtn.onclick = () => {
        const track = localStream.getVideoTracks()[0];
        if (track) {
            track.enabled = !track.enabled;
            sessionStorage.setItem('cameraOff', !track.enabled);
            updateControlButtons();
            
            // Update local UI overlay
            document.getElementById('localVideoContainer').classList.toggle('video-off', !track.enabled);
            
            // Send to others
            if(ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "video-toggle", enabled: track.enabled, from: myId }));
            }
        }
    };

    shareScreenBtn.onclick = async () => {
        // If already sharing, stop
        if (isScreenSharing) {
            manageScreenShareLayout(false);
            setLocalStream(cameraStream); // Revert to camera
            monitorAudioLevel(cameraStream, "localVideoContainer");
            return;
        }
        
        // Start new share
        try {
            const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            
            // Use new layout manager
            manageScreenShareLayout(true);
            
            setLocalStream(screenStream);
            monitorAudioLevel(screenStream, "localVideoContainer");
            
            // Handle "Stop Sharing" button in browser
            screenStream.getVideoTracks()[0].onended = () => {
                manageScreenShareLayout(false);
                setLocalStream(cameraStream);
                monitorAudioLevel(cameraStream, "localVideoContainer");
            };
        } catch (e) {
            console.error("Screen share error:", e);
            manageScreenShareLayout(false); // Revert UI
            setLocalStream(cameraStream);
            monitorAudioLevel(cameraStream, "localVideoContainer");
        }
    };

    captionsBtn.onclick = () => {
        toggleCaptions();
    };

    chatBtn.onclick = () => {
        toggleChat();
    };

    closeChatBtn.onclick = () => {
        toggleChat();
    };

    chatInputForm.onsubmit = (e) => {
        e.preventDefault();
        sendChatMessage(chatInput.value);
    };

    endBtn.onclick = () => {
        sessionStorage.clear();
        Object.values(pcs).forEach(pc => pc.close());
        if (ws) ws.close();
        stopCaptions(); // Ensure captions are stopped
        if (localStream) localStream.getTracks().forEach(track => track.stop());
        if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
        
        if (audioContext && audioContext.state !== 'closed') {
            audioContext.close().then(() => window.location.reload());
        } else {
            window.location.reload();
        }
    };

    window.addEventListener('load', () => {
        const savedRoom = sessionStorage.getItem('room');
        const savedName = sessionStorage.getItem('name');
        if (savedRoom && savedName) {
            // Pre-fill fields for re-join
            roomInput.value = savedRoom;
            nameInput.value = savedName;
            // Automatically join
            joinCall(savedRoom, savedName);
        }
    });
</script>

</body>
</html>